# PDFインポート機能の実装について

## 概要
見積書PDFファイルから情報を抽出してデータベースに取り込む機能を実装しました。

## サポート形式
- ✅ テキストベースのPDF（コピー可能なテキストを含むPDF）
- ❌ 画像スキャンPDF（OCR処理が必要なため現在非対応）

## 抽出可能な情報

### 基本情報
- 顧客名（「様」「御中」の前の文字列）
- 件名・工事名・案件名
- 見積番号（No.）
- 見積日（令和表記対応）

### 納入条件
- 受渡場所・納入場所
- 受渡期限・納期
- 受渡条件・納入条件
- 有効期限
- 支払条件

### 金額情報
- 小計
- 消費税
- 合計金額

### 明細情報
- 品名
- 規格・仕様
- 数量
- 単位
- 単価
- 金額

## 使用方法

1. **PDFファイルを準備**
   - テキストがコピーできることを確認（画像スキャンではないこと）
   - 見積書フォーマットであること

2. **インポート画面でアップロード**
   - ファイル選択で `.pdf` ファイルを指定
   - 「インポート実行」ボタンをクリック

3. **確認画面で内容チェック**
   - 抽出された情報を確認
   - 必要に応じて修正
   - 「保存」で確定

## 技術詳細

### 使用ライブラリ
- `pdf-parse`: PDFからテキストを抽出
- `pdf-lib`: PDF操作用（将来の拡張用）

### 抽出アルゴリズム
1. **ラベルベース検索**
   - 「件名:」「受渡場所:」などのラベルを検索
   - ラベルの右側または次行から値を取得

2. **パターンマッチング**
   - 正規表現で日付、金額、番号などを抽出
   - 令和年号を西暦に自動変換

3. **テーブル構造解析**
   - ヘッダー行（「品名」「数量」「単価」など）を検出
   - 以降の行を明細データとしてパース

### 制限事項
- PDFのレイアウトによって抽出精度が変わる可能性があります
- 複雑なレイアウト（多段組、複雑な表組など）は抽出が困難な場合があります
- 画像ベースのPDFは現在非対応（OCR実装が必要）

## カスタマイズ方法

新しいPDFフォーマットに対応する場合:

### 1. 抽出ルールの追加
`app/api/send-approval-email/import_estimate_pdf/route.ts` の `extractEstimateData` 関数を編集:

```typescript
// 例: 新しいラベルパターンを追加
if (line.includes('工事名称') || line.includes('案件名称')) {
  const parts = line.split(/[:：]/)
  subject = parts.length > 1 ? parts[1].trim() : nextLine
}
```

### 2. テーブルパース処理の調整
明細テーブルの構造に応じて `parts.length` や `split()` の区切り文字を調整:

```typescript
// 例: カンマ区切りの場合
const parts = line.split(',').map(p => p.trim())
```

### 3. 数値抽出ルールの変更
通貨記号や桁区切りが異なる場合、`extractNumber` 関数を調整:

```typescript
function extractNumber(text: string): number | null {
  const cleaned = text.replace(/[,¥円$]/g, '').trim()
  // ...
}
```

## デバッグ方法

1. **ブラウザコンソールの確認**
   - F12キーで開発者ツールを起動
   - Console タブで `[PDF Parse]` のログを確認

2. **テキスト抽出結果の確認**
   - エラー時に `debug.textSample` でPDFテキストの一部を確認
   - レイアウト崩れや文字化けをチェック

3. **段階的デバッグ**
   ```javascript
   console.log('[PDF Parse] 抽出テキスト:', data.text)
   console.log('[PDF Parse] 顧客名:', customerName)
   console.log('[PDF Parse] 明細件数:', details.length)
   ```

## 将来の拡張案

- [ ] OCR対応（画像スキャンPDFの読み取り）
- [ ] 複数ページPDFの対応改善
- [ ] AI/LLMを使った高精度抽出
- [ ] テーブル構造の自動認識強化
- [ ] PDFレイアウト解析（座標ベース）
- [ ] PDFプレビュー機能
- [ ] PDF内の画像抽出（押印など）

## トラブルシューティング

### Q: 「PDFから見積情報を抽出できませんでした」と表示される
**A:** 以下を確認してください:
- PDFがテキストベースであること（テキストをコピーできるか確認）
- 見積書フォーマットであること（件名、顧客名などの項目が含まれているか）

### Q: 明細データが抽出されない
**A:** テーブルのヘッダー行に「品名」「数量」「単価」などのキーワードが含まれているか確認してください。

### Q: 金額が正しく抽出されない
**A:** 「小計」「消費税」「合計」のラベルが含まれているか、数値に桁区切りカンマが使われているか確認してください。

### Q: 日付が正しく認識されない
**A:** 現在対応している日付形式:
- 令和◯年◯月◯日
- YYYY年MM月DD日
- YYYY/MM/DD, YYYY-MM-DD

これ以外の形式の場合、extractEstimateDate 関数のカスタマイズが必要です。
