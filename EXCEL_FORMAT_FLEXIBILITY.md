# Excelファイルの柔軟な読み取り機能

## 概要
見積書Excelファイルのセル位置がファイルによって異なる場合でも、正しく情報を読み取れるように以下の対応策を実装しています。

## 実装された対応策

### 1. **レイアウト自動判定**
- 縦様式と横様式を自動判定
- 明細シートのヘッダー位置（D40、B15など）から判定
- 判定結果に応じて適切なセル位置パターンを使用

### 2. **複数セル位置パターン**
各フィールドで複数の候補セル位置を定義：

#### 縦様式の候補セル位置
```typescript
CELL_PATTERNS_VERTICAL = {
  customerName: ['D8', 'C8', 'D10', 'C10'],
  subject: ['D27', 'D21', 'D25', 'C27', 'C21'],
  deliveryPlace: ['D29', 'D23', 'D31', 'C29'],
  deliveryDeadline: ['D31', 'D25', 'D33', 'C31'],
  deliveryTerms: ['D33', 'D27', 'D35', 'C33'],
  validityText: ['D35', 'D29', 'D37', 'C35'],
  paymentTerms: ['D37', 'D31', 'D39', 'C37'],
}
```

#### 横様式の候補セル位置
```typescript
CELL_PATTERNS_HORIZONTAL = {
  customerName: ['D8', 'C8', 'E8'],
  subject: ['K27', 'K25', 'L27'],
  deliveryPlace: ['K29', 'K27', 'L29'],
  // ... 以下同様
}
```

### 3. **ラベルベース検索（最優先）**
固定セル位置に依存せず、ラベル（項目名）から値を動的に検索：

#### 対応するラベルキーワード
- **件名**: 「件名」「工事名」「案件名」「品名」
- **受渡場所**: 「受渡場所」「納入場所」「納品場所」「受け渡し場所」
- **受渡期限**: 「受渡期限」「納期」「納入期限」「受け渡し期限」
- **受渡条件**: 「受渡条件」「納入条件」「受け渡し条件」
- **有効期限**: 「有効期限」「本書有効期限」「見積有効期限」
- **支払条件**: 「御支払条件」「支払条件」「お支払条件」「支払い条件」

#### ラベル検索の仕組み
1. 探索範囲（15～50行目）を広範囲にスキャン
2. ラベルが見つかったら以下の順で値を検索：
   - 右隣のセル
   - 右2～3列目のセル（セル結合対応）
   - 下1～2行目のセル（縦配置対応）

### 4. **3段階フォールバック方式**
情報取得の優先順位：

```
1. ラベル検索（最優先）
   ↓（見つからない場合）
2. 複数セル候補から試行
   ↓（見つからない場合）
3. 固定セル位置（後方互換性）
```

### 5. **明細列の動的検出**
明細シートのヘッダー行を自動検出：
- 「品名」「規格」「数量」「単価」「金額」などのキーワードから列位置を特定
- 「原価単価」「原価金額」「粗利率」「仕切価格」も動的検出
- 最大104列（A～CZ列）をスキャン

## 使用方法

### 推奨されるExcelフォーマット

#### パターン1: ラベル形式（推奨）
```
C27: 件名          D27: 先行設定量装置
C29: 受渡場所      D29: ご照会の上
C31: 受渡期限      D31: ご照会の上
```

このパターンが最も柔軟で、セル位置が多少ずれても読み取り可能です。

#### パターン2: 固定セル位置
定義された候補セル位置に直接値を配置することも可能です。

### デバッグ機能

すべての読み取り処理でコンソールログを出力：
- `[Excel Parse] レイアウト自動判定: 縦様式`
- `[Excel Parse] 件名検出(右隣): C27="件名", 値=D27="先行設定量装置"`
- `[Excel Parse] セル候補から値取得: D29="ご照会の上"`

ブラウザのデベロッパーツール（F12）→ Console タブで詳細を確認できます。

## 新しいフォーマットへの対応方法

もし既存のパターンで読み取れない場合：

1. **セル位置パターンの追加**
   `CELL_PATTERNS_VERTICAL` または `CELL_PATTERNS_HORIZONTAL` に新しい候補を追加

2. **ラベルキーワードの追加**
   `findValueByLabel()` 呼び出し時のキーワード配列に同義語を追加

3. **探索範囲の調整**
   `findValueByLabel()` の `startRow`, `endRow` パラメータを変更

## 技術詳細

### ヘルパー関数

#### `findValueByLabel(ws, labelKeywords, startRow, endRow)`
ラベルから値を検索

#### `getCellFromCandidates(ws, candidates)`
複数セル候補から最初の非空値を取得

#### `detectLayoutType(wb)`
縦様式/横様式を自動判定

#### `findColumnsByHeader(ws, headerRow)`
明細シートの列位置を動的検出

## まとめ

この実装により、以下のような変動に対応できます：
- ✅ セル位置のずれ（数行・数列のずれ）
- ✅ ラベル名の微妙な違い（同義語）
- ✅ セル結合の有無
- ✅ 縦横レイアウトの違い
- ✅ 明細列の順序変更

特定のフォーマットに強く依存しない、柔軟な設計となっています。
